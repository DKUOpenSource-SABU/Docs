# 🧠 SABU 프로젝트 클러스터링 회고

## 🎯 GOAL

투자자들의 포트폴리오 단위 분산 투자 전략 추천

## 구현 계획

- 기업분석은 정형화 하기 어렵기 때문에 차트분석을 이용한 클러스터링 구현 계획
- 다양한 클러스터링 알고리즘을 이용하여 성능이 좋은 클러스터링 모델 이용
    - K-Means, 계층형 클러스터링, DBSCAN
    - 3가지를 모두 구현하여 사용자가 목적에 맞는 클러스터링을 이용할 수 있도록 계획
- 데이터 전처리 (결측값·이상치 처리, feature 표준화)
- PCA 차원 축소를 이용하여 클러스터링 결과 2차원 시각화
- 클러스터링 결과를 활용한 추가 기능 구현

## 👨‍💻 작업 타임라인 (시행 착오 & 문제 해결)

\* 해당 파트는 작업 타임라인 순서대로 겪었던 시행 착오와 고민 사항, 문제 해결 내용이 기술되어 있습니다.

### 초기 클러스터링
---
#### 다양한 클러스터링 알고리즘

[ DBSCAN, 계층형 클러스터링의 한계 ]

- 코사인 유사도 행렬이 필요
    - 코사인 유사도: feature 벡터 간의 방향 유사성
- 지표 기반 유사도 계산 필요
    - 상관계수를 유사도 지표로 사용 → 거리 행렬로 변환 → 클러스터링 알고리즘 적용
        - 피어슨 상관계수: 시계열 간의 선형 상관관계; 두 벡터를 평균 0으로 중앙 정렬한 뒤 코사인 유사도 계산

<aside>
❌ ISSUE

    - 코사인 유사도는 벡터의 방향 유사성만 측정하고, 벡터의 크기는 무시하므로 벡터의 크기가 중요한 경우 적절한 유사도를 측정하지 못할 수 있음
    - 상관계수를 유사도 지표로 사용 시, 시계열 간의 선형 상관관계 밖에 설명하지 못하는 한계가 존재
    - 두 알고리즘 모두 고차원 데이터에서 거리 기반 유사도의 의미가 약해지고, 클러스터의 경계가 불명확
    - DBSCAN의 경우 파라미터(이웃 반경 ε, 최소 이웃 수 MinPts)에 따라 결과가 크게 변할 수 있고, 직접 클러스터 개수를 설정할 수 없어 시각화에 어려움이 생길 수 있음
    - 계층형 클러스터링의 경우 특히 이상치나 노이즈에 민감
</aside>

<aside>
💡 SOLUTION

    K-Means 클러스터링 우선 구현

    - 대중적인 클러스터링 알고리즘
    - 각 주식 종목 feature 벡터 간의 유클리드 거리로 군집을 형성
    - feature를 표준화 한 뒤 이 벡터 자체를 K-Means 알고리즘에 입력하면 됨
    - 시각화하였을 때 비교적 쉽게 사용자가 직관적으로 이해 가능
</aside>

#### 초기 클러스터링 구현

- 차트 분석에 활용하는 주식 데이터 수집
- 소수 데이터의 가격 지표(종가, 거래량, 현금배당, 주식분할 조정계수)를 가지고 간단한 클러스터링 진행
- 초기에는 주식 종목만을 가지고 진행하려 계획
    
    ❌ 요즘 같은 변동성이 큰 시기에 안전 자산을 많이 찾게 되는데, 주식이 이 모든 것을 반영하기 어려움
    
    💡 ETF 데이터도 함께 수집하여 분산 투자 의미에 맞는 정보 추가
    
    

#### 성능 향상을 위한 노력

- 클러스터링 평가 지표를 활용하여 모델 성능 측정
    - 3가지 평가 지표를 종합하여 성능을 높이는 방향으로 개선
        - 실루엣 계수: 응집도 + 분리도 종합
        - 데이비스-볼딘 지수: 분산 / 거리 비율
        - 칼린스키-하라바츠 지수: 분리도 대비 응집도 비율
- 10,210개 종목(주식 + ETF)의 데이터를 수집
- 데이터 전처리
    - 결측치 제거
    - 상장 폐지되어 최신 정보가 없는 종목 제거
    - 데이터 기간 필터링
        - 종목별 동일한 기간의 데이터로 구성해야 모델의 성능이 높아질 것으로 예상하여 공통된 기간의 데이터만을 유지
        - 기간 설정 시 최소 1년 이상의 데이터가 반영되어야 한다고 판단
        - 1년 이상의 데이터를 보유한 종목 중, 가장 적은 데이터를 보유하고 있는 종목을 기준으로 하여 기간 필터링
    - 추가 지표 생성
        - 수집된 데이터의 지표를 이용하여 이동평균, 수익률, 변동성, RSI, MDD, 평균 거래량 계산
        - 주식은 최신 정보의 영향을 많이 받아 이를 반영할 수 있는 추가 지표가 필요하다고 판단하여 6개월 이동평균, 6개월 수익률, 6개월 변동성 지표 추가 계산
        - 총 9개의feature 생성
        
        ❓ Idea) 모델 성능을 높이기 위해 PCA로 주성분만 남겨놓은 후 클러스터링을 진행하는 방안 검토
        
        → 주성분 분석을 해서 feature를 줄이면 결국 모든 feature 정보를 담지는 못하는 것이므로 기각
        
        ❓ Idea) 시계열 데이터로만 구성 시, 상장 기간의 차이가 있어 가격 지표를 이용한 클러스터링을 하는 것이 적합하지 않을 수 있으므로, 재무제표 같은 동등하게 가진 지표를 이용하는 것을 검토
        
        → 이 경우 추가로 또 다른 데이터를 수집해야 하므로 후순위로 배치
        
    
    <aside>
    💡 기간 필터링과 최신 정보 반영 지표 판단을 위해 활용한 비교
    
      - 1년치 이상 데이터 보유 및 6개월 계산 지표
      - 3년치 이상 데이터 보유 및 6개월 계산 지표
      - 3년치 이상 데이터 보유 및 1년 계산 지표
      
      → 1년치 이상 데이터 보유 및 6개월 계산 지표를 활용했을 때 클러스터링 평가 지표가 가장 높았음
    
    </aside>
    
    - 스케일링
        - 각 feature에 대해 Z-Score 표준화 (평균 0, 분산 1)
- 엘보우 기법을 이용해 최적의 클러스터 수(K) 탐색
    - SSE를 이용한 탐색
    
    ❌ 주식은 투자 가격이 있다 보니 K가 너무 커지면 기초 자산의 크기가 너무 커지는 문제 발생

    💡 K가 4~5의 값이 나올 수 있도록 범위 지정
    
    ❓ Idea) 최적 K를 default로 지정한 후, 사용자가 직접 K를 지정하는 방식 검토
    
    → 일반 사용자는 K-Means 클러스터링을 모를 수 있으므로 기각
    
- K-Means 클러스터링 진행
    
    ❌ 최대한 많은 종목의 정보를 담기 위해 따로 이상치를 처리하지 않았더니 특정 클러스터에 데이터가 쏠리는 문제 발생
    
    <aside>
    💡 SOLUTION
    
      Isolation Forest를 사용하여 이상치 처리
        
      - 다변량 이상치 처리 기법
      - 각 데이터 포인트가 여러 개의 Random Decision Tree에서 고립되는 데 필요한 경로 depth를 기반으로 전체의 5%를 이상치 처리
    </aside>
    
- 이상치 제거 후 K-Means 클러스터링 진행, 시각화
    
    ❌ 클러스터링 결과가 일반 사용자에게는 친숙하지 않을 수 있다는 문제점 제시
    
    💡 사용자의 직관적인 이해를 돕기 위해 분산 투자 점수 로직 구현 (클러스터링 점수화)
    
    

### 초기 분산 투자 점수화
---
- 사용자가 선택한 종목의 클러스터 분포 기반 + 2차원 좌표상 거리 기반 혼합 점수화 구현
    
    ❌ 2차원으로 축소하여 거리 측정 시 원본 데이터의 정보를 담지 못하는 부정확한 결과 발생
    
    💡 원본 9차원 데이터 상의 거리를 비교하는 로직으로 변경
        

### 초기 종목 추천 기능
---
- 클러스터링 결과를 활용하여 종목 추천 기능 구현
- 유클리드 거리 기반 종목 추천
- 사용자가 선택한 종목들의 평균 지점에서 유클리드 거리가 가장 멀리 떨어진 종목 5개 추천
- PCA를 하여 2차원으로 표시한 데이터의 좌표 기준 거리를 이용
    
    ❌ 2차원으로 축소하여 거리 측정 시 원본 데이터의 정보를 담지 못하고 다소 추상적인 종목 추천이 되는 문제 발생
    
    💡 원본 9차원 데이터 상의 거리를 비교하는 로직으로 변경
        

### 공통된 문제 발생 - 이상치
---
<aside>
❌ ISSUE

    [분산 투자 점수화]
    - 이상치를 제거하니 제거된 종목을 선택했을 때 점수 확인이 불가능

    [종목 추천 기능]
    - 이상치를 제거하니 대형주(애플, 테슬라 등)가 빠지는 문제 발생
    - 종목 추천 기능인데 빠지는 종목이 있는 것이 사용자 관점에서 옳지 않음
    ❓ Idea) if문을 이용하여 이상치 데이터의 포함 유무에 따라 이상치 포함/제외 거리를 따로 계산하여 추천하는 방안 검토
    → 논리에 맞지 않아 기각
</aside>

💡 이상치 데이터를 포함시켜 로직을 재구현하는 방안 고안


#### 다시 처음으로, 클러스터링부터 변경

- 이상치 데이터를 포함 시켜 이상치 데이터만의 클러스터를 따로 분류 및 시각화 진행
    
    ❌ PCA 2차원 축소를 시켰을 때 정상 데이터와 이상치 데이터 간의 2차원 좌표 값 차이가 매우 커서 클러스터링 시각화 표현이 잘 되지 않는 문제 발생
    
    💡 시각화 축에서 많이 벗어나는 데이터를 제거
    
    
- 시각화 축에서 많이 벗어나는 데이터를 임의로 정하여 제거
    
    ❌ 제거할 축의 기준을 정할 때 개인의 주관이 들어가 논리적으로 옳지 않고 성능이 낮아질 수 있는 문제 발생
    

#### 각 기능의 Solution

<aside>
💡 SOLUTION

    [공통]
    - 정상 데이터로 K-Means 클러스터링 학습
    - 모델에 이상치 데이터를 넣어 각각의 이상치 데이터를 클러스터에 분류
        
        [클러스터링] - 클러스터별 정상 데이터의 PC1, PC2 평균 이용
        - 정상 데이터의 PC1, PC2 값을 이용하여 클러스터별 PC1, PC2 평균 계산
        - 분류된 이상치 데이터의 PC1, PC2 값을 클러스터별 PC1, PC2 평균 값으로 대체
          ex) 이상치 #1은 클러스터 1로 분류 → 클러스터 1로 분류된 정상 데이터의 PC1, PC2 평균 값으로 이상치 #1의 PC1, PC2 값 대체
        
        [분산 투자 점수화, 종목 추천 기능] - 클러스터별 정상 데이터의 feature 평균 이용
        - 클러스터별 정상 데이터의 feature 평균 계산
        - 분류된 이상치 데이터의 feature 값을 클러스터별 정상 데이터의 feature 평균 값으로 대체
          ex) 이상치 #1은 클러스터 1로 분류 → 클러스터 1로 분류된 정상 데이터의 feature 평균 값으로 이상치 #1의 feature 값 대체
</aside>

### 분산 투자 점수화 성능 향상 (이상치 문제 해결 후)
---
❌ 분산 투자 점수이므로 사용자의 종목별 투자 비율이 반영되어야 한다는 문제점 제시

💡 투자 비율을 가중치로 반영


❌ 클러스터 분포 점수 산정 로직에서 최대 1이 나와야 하는데, 아무리 동일한 비율의 클러스터 개수를 선택하여도 최대 0.75가 나오는 문제 발생

<aside>
💡 SOLUTION

    - 1 - (클러스터별 비중의 제곱합)을 계산하여 균등성 점수 산출
    - 실제 점수를 최대 점수로 나누어 정규화
    - 0 ~ 1 사이 점수 산출
</aside>

### 종목 추천 기능 성능 향상 (이상치 문제 해결 후)
---
❌ 거리 기반의 추천을 구현하니 어떤 종목을 선택하든 항상 가장 멀리 있는 종목만을 추천하는 문제 발생

<aside>
💡 SOLUTION

    클러스터 기반 추천 추가

    - 사용자가 선택한 종목의 클러스터 개수 반영
    - 추천의 우선순위를 선택된 클러스터의 개수가 가장 적은 쪽으로 구현
      ex) 클러스터 1: 2개, 클러스터 2: 2개, 클러스터 3: 1개, 클러스터 4: 1개 → 총 6개 종목 선택
          - 6개 종목의 평균 지점 계산
          - 가장 적게 선택된 클러스터 3, 4 중 평균 지점과 거리가 가장 먼 것을 추천
</aside>

### 섹터별 거리 시각화
---
- 섹터의 정보를 추가적으로 제공하기 위해 섹터별 거리 시각화 기능 구현
- Nasdaq에서 수집된, 섹터 정보가 있는 주식만 가지고 진행
- 클러스터링에서 활용한 데이터셋 중 섹터 정보가 있는 종목을 추출
- 섹터별로 그룹화하여 feature마다 IQR을 이용해 이상치 처리
- 섹터별 feature의 평균을 계산
- PCA로 2차원 축소하여 섹터별로 거리가 얼마나 떨어져 있는지 시각화

## 👍 잘한 점

- 데이터를 분석하기 위한 기획을 활발히 소통한 점
- 클러스터링 모델 성능 향상을 위한 노력
- 모델의 성능 뿐만이 아닌, 성능 측정 지표에서 나오지 않는 논리적인 문제 해결
- 클러스터링 결과를 이용한 추가 기능 구현
- 사용자 관점에서의 접근으로 문제 해결 시도

## 😢 아쉬운 점

- 다양한 클러스터링을 적용해보지 못한 점
- 더 많은 지표를 사용하지 못한 점
- 이상치 처리
    - 이상치끼리 같은 값을 가지게 되므로 이 부분에서 더 좋은 방법으로 처리를 하지 못한 점
- 클러스터에 대한 분석을 진행하지 못한 점
    - 클러스터에서 종목들이 가지는 공통점 등

## 💡 다음 단계

- K-Means 클러스터링 모델 성능 향상
- 클러스터에 대한 분석 진행
- 다양한 클러스터링 알고리즘 구현

> 작성자: 김동혁
> 
> 프로젝트 기간: 2025년 4월 ~ 6월
> 
> 주요 기술: Pandas, NumPy, Scikit-learn (KMeans, PCA, Euclidian Distance), Matplotlib